L.Polyline.plotter=L.Polyline.extend({_lineMarkers:[],_editIcon:L.divIcon({className:"leaflet-div-icon leaflet-editing-icon"}),_halfwayPointMarkers:[],_existingLatLngs:[],options:{weight:2,color:"#000",readOnly:!1},initialize:function(i,t){this._setExistingLatLngs(i),L.Polyline.prototype.initialize.call(this,[],t)},onAdd:function(i){L.Polyline.prototype.onAdd.call(this,i),this._map=i,this._plotExisting(),this.options.readOnly||this._bindMapClick()},onRemove:function(){for(var i=0;i<this._halfwayPointMarkers.length;i++)this._map.removeLayer(this._halfwayPointMarkers[i]);for(var i=0;i<this._lineMarkers.length;i++)this._map.removeLayer(this._lineMarkers[i]);this._halfwayPointMarkers=this._lineMarkers=[],this._unbindMapClick(),L.Polyline.prototype.onRemove.call(this,map)},setLatLngs:function(i){L.Polyline.prototype.setLatLngs.call(this,i)},setReadOnly:function(i){if(i&&!this.options.readOnly){var t="_unbindMarkerEvents",n="_unbindHalfwayMarker";this._unbindMapClick()}else if(!i&&this.options.readOnly){var t="_bindMarkerEvents",n="_bindMarkerEvents";this._bindMapClick()}if("undefined"!=typeof t){this.options.readOnly=i;for(var e=0;e<this._halfwayPointMarkers.length;e++)this[n](this._halfwayPointMarkers[e]);for(var e=0;e<this._lineMarkers.length;e++)this[t](this._lineMarkers[e])}},_bindMapClick:function(){this._map.on("click",this._onMapClick,this)},_unbindMapClick:function(){this._map.off("click",this._onMapClick,this)},_setExistingLatLngs:function(i){this._existingLatLngs=i},_replot:function(){this._redraw(),this._redrawHalfwayPoints()},_getNewMarker:function(i,t){return new L.marker(i,t)},_unbindMarkerEvents:function(i){i.off("click",this._removePoint,this),i.off("drag",this._replot,this),i.dragging.disable()},_bindMarkerEvents:function(i){i.on("click",this._removePoint,this),i.on("drag",this._replot,this),i.dragging.enable()},_bindHalfwayMarker:function(i){i.on("click",this._addHalfwayPoint,this)},_unbindHalfwayMarker:function(i){i.off("click",this._addHalfwayPoint,this)},_addToMapAndBindMarker:function(i){i.addTo(this._map),this.options.readOnly||this._bindMarkerEvents(i)},_removePoint:function(i){this._map.removeLayer(this._lineMarkers[this._lineMarkers.indexOf(i.target)]),this._lineMarkers.splice(this._lineMarkers.indexOf(i.target),1),this._replot()},_onMapClick:function(i){this._addNewMarker(i),this._replot()},_addNewMarker:function(i){var t=this._getNewMarker(i.latlng,{icon:this._editIcon});this._addToMapAndBindMarker(t),this._lineMarkers.push(t)},_redrawHalfwayPoints:function(){for(var i=0;i<this._halfwayPointMarkers.length;i++)this._map.removeLayer(this._halfwayPointMarkers[i]);this._halfwayPointMarkers=[];for(var i=0;i<this._lineMarkers.length;i++){if(i=parseInt(i),"undefined"==typeof this._lineMarkers[i+1])return;var t=new L.Marker([(this._lineMarkers[i].getLatLng().lat+this._lineMarkers[i+1].getLatLng().lat)/2,(this._lineMarkers[i].getLatLng().lng+this._lineMarkers[i+1].getLatLng().lng)/2],{icon:this._editIcon,opacity:.5}).addTo(this._map);t.index=i,this.options.readOnly||this._bindHalfwayMarker(t),this._halfwayPointMarkers.push(t)}},_addHalfwayPoint:function(i){var t=this._getNewMarker(i.latlng,{icon:this._editIcon});this._addToMapAndBindMarker(t),this._lineMarkers.splice(i.target.index+1,0,t),this._replot()},_plotExisting:function(){for(var i=0;i<this._existingLatLngs.length;i++)this._addNewMarker({latlng:new L.LatLng(this._existingLatLngs[i][0],this._existingLatLngs[i][1])});this._replot()},_redraw:function(){this.setLatLngs([]),this.redraw();for(var i=0;i<this._lineMarkers.length;i++)this.addLatLng(this._lineMarkers[i].getLatLng());this.redraw()}}),L.Polyline.Plotter=function(i,t){return new L.Polyline.plotter(i,t)};